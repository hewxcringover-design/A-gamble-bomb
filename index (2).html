<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mines Balanced Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Kanit', sans-serif; }
        body { background: #0b0e11; color: white; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        .header { padding: 10px; display: flex; justify-content: center; }
        .balance-pill { background: #1a1d23; padding: 6px 25px; border-radius: 50px; border: 1px solid #4caf50; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .balance-pill span { color: #4caf50; font-weight: 600; font-size: 1.2rem; }

        .game-area { flex: 1; display: flex; align-items: center; justify-content: center; padding: 15px; }
        #grid { display: grid; gap: 8px; background: #151921; padding: 12px; border-radius: 20px; width: 100%; max-width: 350px; }
        .cell { aspect-ratio: 1/1; background: #2d333f; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: inset 0 -4px 0 rgba(0,0,0,0.3); transition: 0.1s; border: 1px solid transparent; }
        .cell.reveal-diamond { background: linear-gradient(145deg, #388e3c, #4caf50); border: 1px solid #66bb6a; box-shadow: none; }
        .cell.reveal-bomb { background: linear-gradient(145deg, #b71c1c, #f44336); border: 1px solid #ef5350; box-shadow: none; }

        .footer { background: #1a1d23; padding: 15px 20px 25px; border-top-left-radius: 30px; border-top-right-radius: 30px; }
        .selector-row { display: flex; background: #0f1216; border-radius: 12px; padding: 4px; margin-bottom: 15px; border: 1px solid #3d4452; }
        .mode-btn { flex: 1; padding: 10px; text-align: center; font-size: 0.9rem; border-radius: 8px; cursor: pointer; color: #8a94a6; transition: 0.3s; }
        .mode-btn.active { background: #3d4452; color: white; font-weight: 600; }
        
        .inputs-row { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .input-group { width: 100%; }
        .input-group label { font-size: 0.75rem; color: #5c6577; display: flex; justify-content: space-between; margin-bottom: 8px; text-transform: uppercase; }
        .mine-count-display { color: #ff9800; font-weight: bold; font-size: 1rem; }

        .slider-container { display: flex; align-items: center; gap: 10px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: #0f1216; height: 10px; border-radius: 5px; outline: none; border: 1px solid #3d4452; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: #ff9800; border-radius: 50%; cursor: pointer; border: 2px solid #fff; }

        .bet-container { position: relative; display: flex; align-items: center; width: 100%; }
        .bet-input { width: 100%; background: #0f1216; color: white; border: 1px solid #3d4452; padding: 12px; border-radius: 10px; text-align: center; font-size: 1.1rem; outline: none; }
        .max-btn { position: absolute; right: 8px; padding: 5px 12px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; font-size: 0.7rem; font-weight: bold; cursor: pointer; color: #4caf50; border: 1px solid #4caf50; }

        .btn-action { width: 100%; padding: 16px; border: none; border-radius: 15px; font-size: 1.2rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        #startBtn { background: #ff9800; color: #000; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3); }
        #cashoutBtn { background: #4caf50; color: white; display: none; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3); }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: #1a1d23; width: 300px; padding: 40px 20px; border-radius: 30px; text-align: center; border: 1px solid #3d4452; }
    </style>
</head>
<body>

    <div class="header">
        <div class="balance-pill">ðŸ’° <span id="balance">1,000.00</span> à¸¿</div>
    </div>

    <div class="game-area">
        <div id="grid"></div>
    </div>

    <div class="footer">
        <div class="selector-row">
            <div class="mode-btn" id="m3" onclick="setGridSize(3)">3 x 3</div>
            <div class="mode-btn active" id="m5" onclick="setGridSize(5)">5 x 5</div>
        </div>

        <div class="inputs-row">
            <div class="input-group">
                <label>à¹€à¸”à¸´à¸¡à¸žà¸±à¸™ <span style="color:#8a94a6">MAX: <span id="maxDisplay">1,000</span></span></label>
                <div class="bet-container">
                    <input type="number" id="betIn" class="bet-input" value="10">
                    <div class="max-btn" onclick="setMaxBet()">MAX</div>
                </div>
            </div>
            
            <div class="input-group">
                <label>à¸£à¸°à¹€à¸šà¸´à¸”: <span class="mine-count-display" id="mineNum">3</span></label>
                <div class="slider-container">
                    <input type="range" id="mineSlider" min="1" max="24" value="3" oninput="updateMineUI()">
                </div>
            </div>
        </div>

        <button id="startBtn" class="btn-action" onclick="beginGame()">START GAME</button>
        <button id="cashoutBtn" class="btn-action" onclick="claimWin()">CASHOUT (x1.00)</button>
    </div>

    <div class="overlay" id="overlay">
        <div class="modal">
            <h2 id="resTitle" style="margin:0">RESULT</h2>
            <p id="resDesc"></p>
            <button class="btn-action" style="background:#4caf50; color:white;" onclick="hideModal()">OK</button>
        </div>
    </div>

    <script>
        let balance = 1000.00, gSize = 5, isLive = false;
        let mines = [], openCount = 0, betAmount = 0, currentX = 1.0;
        let secretHistory = {};

        const audio = new (window.AudioContext || window.webkitAudioContext)();
        function sfx(t) {
            const o = audio.createOscillator(); const g = audio.createGain();
            o.connect(g); g.connect(audio.destination);
            if(t==='d'){ o.type='sine'; o.frequency.setValueAtTime(400+(openCount*100), audio.currentTime); g.gain.setValueAtTime(0.1, audio.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime+0.2); o.start(); o.stop(audio.currentTime+0.2); }
            else if(t==='b'){ o.type='sawtooth'; o.frequency.setValueAtTime(80, audio.currentTime); g.gain.setValueAtTime(0.3, audio.currentTime); g.gain.linearRampToValueAtTime(0, audio.currentTime+0.6); o.start(); o.stop(audio.currentTime+0.6); }
            else if(t==='u'){ o.type='square'; o.frequency.setValueAtTime(1000, audio.currentTime); g.gain.setValueAtTime(0.03, audio.currentTime); o.start(); o.stop(audio.currentTime+0.05); }
        }

        function setMaxBet() { if(isLive) return; sfx('u'); document.getElementById('betIn').value = balance.toFixed(2); }

        function updateMineUI() {
            document.getElementById('mineNum').innerText = document.getElementById('mineSlider').value;
            sfx('u');
        }

        function setGridSize(s) { 
            if(isLive) return; sfx('u'); gSize = s;
            document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('m'+s).classList.add('active');
            const slider = document.getElementById('mineSlider');
            const maxAllowed = (s * s) - 1;
            slider.max = maxAllowed;
            if(parseInt(slider.value) > maxAllowed) slider.value = maxAllowed;
            updateMineUI();
            drawGrid(); 
        }

        function drawGrid() {
            const g = document.getElementById('grid'); g.innerHTML = ''; g.style.gridTemplateColumns = `repeat(${gSize}, 1fr)`;
            for(let i=0; i < gSize*gSize; i++) { const c = document.createElement('div'); c.className = 'cell'; g.appendChild(c); }
        }

        // --- à¸ªà¸¹à¸•à¸£à¸„à¸³à¸™à¸§à¸“à¸•à¸±à¸§à¸„à¸¹à¸“à¹ƒà¸«à¸¡à¹ˆ (Balanced Formula) ---
        function calcX(total, bombCount, foundCount) {
            let n = total;
            let k = bombCount;
            let j = foundCount;

            // à¸„à¸³à¸™à¸§à¸“à¸„à¸§à¸²à¸¡à¸™à¹ˆà¸²à¸ˆà¸°à¹€à¸›à¹‡à¸™à¸—à¸²à¸‡à¸„à¸“à¸´à¸•à¸¨à¸²à¸ªà¸•à¸£à¹Œ P = (n-k C j) / (n C j)
            function combinations(n, r) {
                if (r < 0 || r > n) return 0;
                if (r === 0 || r === n) return 1;
                if (r > n / 2) r = n - r;
                let res = 1;
                for (let i = 1; i <= r; i++) res = res * (n - i + 1) / i;
                return res;
            }

            let prob = combinations(n - k, j) / combinations(n, j);
            
            // à¸›à¸£à¸±à¸šà¸•à¸±à¸§à¸„à¸¹à¸“à¹ƒà¸«à¹‰à¸•à¸£à¸‡à¸•à¸²à¸¡à¹‚à¸ˆà¸—à¸¢à¹Œ: 3x3 (9à¸Šà¹ˆà¸­à¸‡) à¸£à¸°à¹€à¸šà¸´à¸” 3 à¸à¸”à¸„à¸£à¸š (6à¸Šà¹ˆà¸­à¸‡) = ~36.00
            // à¹ƒà¸Šà¹‰ House Edge 0.95 à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¹€à¸¥à¸‚à¸­à¸­à¸à¸¡à¸²à¸ªà¸§à¸¢à¸‡à¸²à¸¡à¸•à¸²à¸¡à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£
            let multiplier = (1 / prob) * 0.95; 

            return multiplier;
        }

        function beginGame() {
            sfx('u');
            const b = parseFloat(document.getElementById('betIn').value);
            const m = parseInt(document.getElementById('mineSlider').value);
            const total = gSize * gSize;
            if (b > balance || b <= 0) return;
            
            balance -= b; betAmount = b; refreshUI();
            isLive = true; openCount = 0; mines = [];

            // à¸£à¸°à¸šà¸šà¹à¸­à¸šà¸ˆà¸³à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡ (Hidden AI)
            let pool = [];
            for(let i=0; i<total; i++) {
                let weight = 1 + (secretHistory[i] || 0);
                for(let w=0; w<weight; w++) pool.push(i);
            }

            while(mines.length < m) {
                let r = pool[Math.floor(Math.random() * pool.length)];
                if(!mines.includes(r)) mines.push(r);
            }

            const g = document.getElementById('grid'); g.innerHTML = '';
            for(let i=0; i<total; i++) {
                const c = document.createElement('div'); c.className = 'cell';
                c.onclick = () => { if(!isLive || c.classList.contains('disabled')) return;
                    secretHistory[i] = (secretHistory[i] || 0) + 1;
                    if(mines.includes(i)) {
                        sfx('b'); c.innerHTML = 'ðŸ’£'; c.classList.add('reveal-bomb');
                        popModal("BOOM!", "à¸¢à¸­à¸”à¹€à¸ªà¸µà¸¢: " + betAmount.toFixed(2) + " à¸¿", "#f44336"); finishGame();
                    } else {
                        openCount++; sfx('d'); c.innerHTML = 'ðŸ’Ž'; c.classList.add('reveal-diamond', 'disabled');
                        currentX = calcX(total, m, openCount);
                        document.getElementById('cashoutBtn').innerText = `à¸–à¸­à¸™à¹€à¸‡à¸´à¸™ (x${currentX.toFixed(2)})`;
                        if(openCount === (total - m)) claimWin();
                    }
                };
                g.appendChild(c);
            }
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('cashoutBtn').style.display = 'block';
            document.getElementById('cashoutBtn').innerText = `à¸–à¸­à¸™à¹€à¸‡à¸´à¸™ (x1.00)`;
        }

        function claimWin() {
            if(!isLive) return; sfx('u');
            const win = betAmount * currentX; balance += win;
            popModal("WINNER!", `à¹„à¸”à¹‰à¸£à¸±à¸š: <b>${win.toFixed(2)}</b> à¸¿<br>à¸•à¸±à¸§à¸„à¸¹à¸“: <b>x${currentX.toFixed(2)}</b>`, "#4caf50");
            finishGame();
        }

        function finishGame() { isLive = false; document.getElementById('startBtn').style.display = 'block'; document.getElementById('cashoutBtn').style.display = 'none'; document.querySelectorAll('.cell').forEach((c, i) => { if(mines.includes(i)) c.innerHTML = 'ðŸ’£'; }); refreshUI(); }
        function refreshUI() { 
            document.getElementById('balance').innerText = balance.toLocaleString(undefined, {minimumFractionDigits: 2}); 
            document.getElementById('maxDisplay').innerText = balance.toLocaleString(undefined, {maximumFractionDigits: 0});
        }
        function popModal(t, d, c) { document.getElementById('resTitle').innerText = t; document.getElementById('resTitle').style.color = c; document.getElementById('resDesc').innerHTML = d; document.getElementById('overlay').style.display = 'flex'; }
        function hideModal() { sfx('u'); document.getElementById('overlay').style.display = 'none'; }

        window.onload = drawGrid;
    </script>
</body>
</html>
